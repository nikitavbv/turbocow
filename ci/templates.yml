.cargo_base:
  image: $CI_REGISTRY_IMAGE/rust_openssl:0.1.17
  cache:
    paths:
      - $CRATE_NAME/target
      - .cargo

.cargo_test:
  extends: .cargo_base
  stage: build
  needs: []
  except:
    - tags
  script:
    - cd $CRATE_NAME && cargo +nightly test && cd ..

.cargo_build:
  extends: .cargo_base
  stage: build
  needs: []
  except:
    - tags
  variables:
    CARGO_ARGS: ''
  script:
    - cd $CRATE_NAME && cargo +nightly build --release $CARGO_ARGS && cd ..

.cargo_build_executable:
  extends: .cargo_build
  artifacts:
    paths:
      - $CRATE_NAME/target/release/$CRATE_NAME
    expire_in: 1 week
  only:
    refs:
      - master

.cargo_build_executable_windows:
  extend: .cargo_build_executable
  variables:
    CARGO_ARGS: '--target x86_64-pc-windows-gnu'

.cargo_build_lib:
  extends: .cargo_build
  artifacts:
    paths:
      - $CRATE_NAME/target/release/lib$CRATE_NAME.so
    expire_in: 1 week
  only:
    refs:
      - master

.image_build:
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: ['']
  only:
    refs:
      - master
  variables:
    DOCKERFILE_PATH: images/$DOCKERFILE_NAME.Dockerfile
    KANIKO_ARGS: ''
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"gitlab-ci-token\",\"password\":\"$CI_JOB_TOKEN\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR $KANIKO_ARGS --dockerfile $CI_PROJECT_DIR/$DOCKERFILE_PATH --destination $CI_REGISTRY_IMAGE/$IMAGE_NAME:$IMAGE_VERSION_PREFIX.$CI_PIPELINE_IID
    - echo built $CI_REGISTRY_IMAGE/$IMAGE_NAME:$IMAGE_VERSION_PREFIX.$CI_PIPELINE_IID

.service_build:
  extends: .image_build
  stage: images
  variables:
    DOCKERFILE_NAME: service
    KANIKO_ARGS: "--build-arg CRATE_NAME=$CRATE_NAME"

.storage_upload:
  stage: deploy
  image: $CI_REGISTRY_IMAGE/deploy_tools:0.1.20
  before_script:
    - gcloud auth activate-service-account --key-file $SERVICE_ACCOUNT_KEY
  
.plugin_deploy:
  extends: .storage_upload
  script:
    - gsutil cp $CRATE_NAME/target/release/lib$CRATE_NAME.so gs://turbocow/plugins/lib$CRATE_NAME.so